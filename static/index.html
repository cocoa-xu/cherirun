<!DOCTYPE html>
<html>
  <head>
    <title>CheriBSD</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1" />
    <meta httpEquiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="language" content="English" />
    <meta name="description" content="Run CheriBSD in Browser" />
    <meta name="author" content="Cocoa Xu" />
    <meta name="keywords" content="cheribsd, morello, online, virtual machine, qemu, purecap, hybrid" />
    <link rel="stylesheet" href="/css/xterm.css" />
    <link rel="stylesheet" href="/css/style.css" />
    <link rel='stylesheet' href='https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.2/themes/smoothness/jquery-ui.css' />
    <script src="/js/xterm.js"></script>
    <script src="/js/xterm-addon-fit.js"></script>
    <script src="/js/xterm-addon-web-links.js"></script>
    <script src="/js/xterm-addon-canvas.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  </head>
  <body class="night">
    <div class="desktop" >
      <div class="window window--terminal" data-window="terminal"
        style="width:800px;height:560px;top:16%;left:20%;">
        <div class="window__handler">
          <div class="window__title" style="font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;">Terminal</div>
          <div class="window__controls">
            <a class="window__close"></a>
            <a class="window__minimize" style="pointer-events: none;"></a>
            <a class="window__maximize"></a>
          </div>
        </div>
        <div class="window__body">
          <div id="terminal" style="width: 100%; height: calc(100% - 25px); margin: 2px 2px 2px 2px;"></div>
        </div>
      </div>
    </div>
    <div class="context" hidden></div>
    <script>
      const theme = {
        // Define your base theme colors
        // (These are just examples; adjust them as needed)
        background: '#000000',
        foreground: '#ffffff',
        cursor: '#ffffff',
        cursorAccent: '#000000',
        selection: 'rgba(255, 255, 255, 0.3)',
        black: '#000000',
        red: '#ff0000',
        green: '#00ff00',
        yellow: '#ffff00',
        blue: '#0000ff',
        magenta: '#ff00ff',
        cyan: '#00ffff',
        white: '#ffffff',
        brightBlack: '#808080',
        brightRed: '#ff0000',
        brightGreen: '#00ff00',
        brightYellow: '#ffff00',
        brightBlue: '#0000ff',
        brightMagenta: '#ff00ff',
        brightCyan: '#00ffff',
        brightWhite: '#ffffff',

        // Define styles for extended ANSI escape sequences (16-255)
        extendedAnsi: (() => {
          const extendedAnsi = {};

          for (let i = 16; i <= 255; i++) {
            // Calculate the corresponding RGB values for each index
            // This calculation is based on the xterm 256-color palette formula
            const colorIndex = i - 16;
            const r = Math.floor(colorIndex / 36) * 51;
            const g = Math.floor((colorIndex % 36) / 6) * 51;
            const b = (colorIndex % 6) * 51;

            // Convert RGB values to hexadecimal format
            const color = `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`;

            // Assign the color to the extendedAnsi object
            extendedAnsi[i.toString()] = { color };
          }

          return extendedAnsi;
        })()
      };
      var socket = io()
      var term = new Terminal({
        rows: 24,
        cols: 80,
        allowProposedApi: true,
        allowTransparency: true,
        theme: theme,
      })
      const fitAddon = new FitAddon.FitAddon()
      term.loadAddon(fitAddon)
      term.loadAddon(new WebLinksAddon.WebLinksAddon())
      term.open(document.getElementById('terminal'))
      term.loadAddon(new CanvasAddon.CanvasAddon())
      term.onResize((evt) => {
        socket.emit('resize', {cols: evt.cols, rows: evt.rows})
      })
      fitAddon.fit()
      const term_resize_ob = new ResizeObserver((entries) => {
        try {
          fitAddon && fitAddon.fit()
        } catch (err) {
          console.log(err)
        }
      })
      term_resize_ob.observe(document.getElementById('terminal'))
      socket.on('disconnect', () => {
        // term.write('Disconnected from server\n')
      })
      socket.on('data', (data) => {
        term.write(data)
      })
      term.onData((data) => {
        socket.emit('data', data)
      })
    </script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js'></script>
    <script src='https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.2/jquery-ui.min.js'></script>
    <script src='https://cdn.rawgit.com/desandro/masonry/master/dist/masonry.pkgd.min.js'></script>
    <script src="/js/script.js"></script>
  </body>
</html>
